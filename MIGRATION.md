# Миграция из bronivik_jr

Этот документ описывает, какие изменения были внесены при выделении bronivik_crm в отдельный репозиторий.

## Проблемы, которые были исправлены

### 1. Опечатки в импортах
**Было**: `tgbotcrmapi` (неправильный алиас)
**Стало**: `tgbotapi`

Исправлено во всех файлах:
- `internal/bot/bot.go`
- `internal/bot/calendar.go`

### 2. Опечатки в вызовах API
**Было**: `b.crmapi.GetAvailability()` и `b.crmapi.ListItems()`
**Стало**: `b.api.GetAvailability()` и `b.api.ListItems()`

### 3. Обновление зависимостей
Добавлены отсутствующие зависимости в `go.mod`:
- `github.com/stretchr/testify` для тестов
- Все транзитивные зависимости

### 4. Структура проекта
Созданы недостающие файлы:
- `Makefile` — команды для сборки, тестирования, линтинга
- `.env.example` — шаблон переменных окружения
- `docker-compose.yml` — для локального запуска с Redis
- `.golangci.yml` — конфигурация линтера
- `CONTRIBUTING.md` — руководство для контрибьюторов
- `LICENSE` — MIT лицензия

### 5. Dockerfile
Обновлен для корректной сборки с SQLite (требуется CGO):
- Добавлена установка `gcc` и `musl-dev`
- Добавлена установка `sqlite-libs` в финальном образе
- `CGO_ENABLED=1` при сборке

### 6. README.md
Полностью переписан с подробным описанием:
- Инструкции по установке и запуску
- Описание архитектуры
- Список всех команд бота
- Примеры конфигурации
- Информация об интеграции с Bronivik Jr API

## Что НЕ было перенесено из bro_jr

### Файлы, специфичные для основного сервиса:
- `configs/items.yaml` — список оборудования (загружается через API)
- `internal/api/` — gRPC и HTTP API сервер
- `internal/google/` — синхронизация с Google Sheets
- `internal/worker/` — асинхронная очередь задач
- `internal/events/` — event bus
- `proto/` — protobuf определения
- `scripts/` — скрипты миграции
- `monitoring/` — конфигурация Prometheus

Эти компоненты относятся только к bronivik_jr и не требуются для работы CRM бота.

## Текущее состояние

### ✅ Готово к работе:
- Исправлены все опечатки в коде
- Добавлены все необходимые зависимости
- Создана полная инфраструктура (Docker, Makefile и т.д.)
- Написана подробная документация
- Сохранены все существующие тесты

### ⚠️ Требует внимания:
- Запуск `go mod tidy` для обновления зависимостей (требуется Go 1.24+)
- Настройка `.env` файла с реальными токенами
- Запуск тестов для проверки работоспособности
- Возможно потребуется создать дополнительные тесты

## Следующие шаги

1. Установите Go 1.24 или выше
2. Запустите `go mod tidy` для обновления зависимостей
3. Скопируйте `.env.example` в `.env` и заполните реальными значениями
4. Запустите тесты: `make test`
5. Запустите линтер: `make lint`
6. Соберите проект: `make build`
7. Запустите бота локально или через Docker Compose

## Интеграция с Bronivik Jr

CRM бот подключается к API основного сервиса для проверки доступности оборудования. Убедитесь, что:

1. Bronivik Jr API запущен и доступен
2. В конфиге CRM указан правильный URL API (по умолчанию `http://grpc-api:8080`)
3. Настроены правильные API ключи (`CRM_API_KEY` и `CRM_API_EXTRA`)

## Структура базы данных

CRM использует собственную SQLite базу с таблицами:
- `users` — пользователи Telegram
- `cabinets` — физические кабинеты
- `cabinet_schedules` — расписание работы кабинетов
- `hourly_bookings` — почасовые бронирования

База создается автоматически при первом запуске.

## Тестирование

```bash
# Запуск всех тестов
make test

# Только определенный пакет
go test -v ./internal/bot

# С покрытием
make test-coverage
```

## Проблемы и решения

Если возникают проблемы:

1. **Ошибки импортов**: проверьте, что все пакеты обновлены (`go mod tidy`)
2. **SQLite ошибки**: убедитесь, что CGO включен и установлен gcc
3. **Redis недоступен**: Redis опционален, бот работает и без него (без кэширования)
4. **API недоступен**: без доступа к Bronivik Jr API функция проверки оборудования не работает

## Контакты

При возникновении вопросов создайте issue в репозитории.
